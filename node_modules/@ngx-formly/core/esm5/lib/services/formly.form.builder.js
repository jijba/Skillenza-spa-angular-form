/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { FormGroup, FormArray, FormControl, AbstractControl, Validators } from '@angular/forms';
import { FormlyConfig } from './formly.config';
import { FORMLY_VALIDATORS, evalStringExpression, evalExpressionValueSetter, getFieldId, isObject, isNullOrUndefined, clone, assignModelToFields } from './../utils';
import { getKeyPath, isFunction } from '../utils';
import { FormlyFormExpression } from './formly.form.expression';
var FormlyFormBuilder = /** @class */ (function () {
    function FormlyFormBuilder(formlyConfig, formlyFormExpression) {
        this.formlyConfig = formlyConfig;
        this.formlyFormExpression = formlyFormExpression;
        this.formId = 0;
    }
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    FormlyFormBuilder.prototype.buildForm = /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} model
     * @param {?=} options
     * @return {?}
     */
    function (form, fields, model, options) {
        if (fields === void 0) { fields = []; }
        var /** @type {?} */ fieldTransforms = (options && options.fieldTransform) || this.formlyConfig.extras.fieldTransform;
        if (!Array.isArray(fieldTransforms)) {
            fieldTransforms = [fieldTransforms];
        }
        fieldTransforms.forEach(function (fieldTransform) {
            if (fieldTransform) {
                fields = fieldTransform(fields, model, form, options);
                if (!fields) {
                    throw new Error('fieldTransform must return an array of fields');
                }
            }
        });
        assignModelToFields(fields, model);
        this._buildForm(form, fields, options);
        this.formlyFormExpression.checkFields(form, fields, model, options);
    };
    /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} options
     * @return {?}
     */
    FormlyFormBuilder.prototype._buildForm = /**
     * @param {?} form
     * @param {?=} fields
     * @param {?=} options
     * @return {?}
     */
    function (form, fields, options) {
        if (fields === void 0) { fields = []; }
        this.formId++;
        this.registerFormControls(form, fields, options);
    };
    /**
     * @param {?} form
     * @param {?} fields
     * @param {?} options
     * @return {?}
     */
    FormlyFormBuilder.prototype.registerFormControls = /**
     * @param {?} form
     * @param {?} fields
     * @param {?} options
     * @return {?}
     */
    function (form, fields, options) {
        var _this = this;
        fields.forEach(function (field, index) {
            field.id = getFieldId("formly_" + _this.formId, field, index);
            _this.initFieldOptions(field);
            _this.initFieldExpression(field, options);
            _this.initFieldValidation(field);
            _this.initFieldWrappers(field);
            _this.initFieldAsyncValidation(field);
            if (field.key && field.type) {
                var /** @type {?} */ paths_1 = getKeyPath({ key: field.key });
                var /** @type {?} */ rootForm_1 = form, /** @type {?} */ rootModel_1 = field.model;
                paths_1.forEach(function (path, index) {
                    // FormGroup/FormArray only allow string value for path
                    var /** @type {?} */ formPath = path.toString();
                    // is last item
                    if (index === paths_1.length - 1) {
                        _this.addFormControl(rootForm_1, field, rootModel_1, formPath);
                        if (field.fieldArray) {
                            field.fieldGroup = [];
                            field.model.forEach(function (m, i) { return field.fieldGroup.push(tslib_1.__assign({}, clone(field.fieldArray), { key: "" + i })); });
                            assignModelToFields(field.fieldGroup, rootModel_1);
                        }
                    }
                    else {
                        var /** @type {?} */ nestedForm = /** @type {?} */ (rootForm_1.get(formPath));
                        if (!nestedForm) {
                            nestedForm = new FormGroup({});
                            _this.addControl(rootForm_1, formPath, nestedForm);
                        }
                        if (!rootModel_1[path]) {
                            rootModel_1[path] = typeof path === 'string' ? {} : [];
                        }
                        rootForm_1 = nestedForm;
                        rootModel_1 = rootModel_1[path];
                    }
                });
            }
            if (field.fieldGroup) {
                if (!field.type) {
                    field.type = 'formly-group';
                }
                // if `hideExpression` is set in that case we have to deal
                // with toggle FormControl for each field in fieldGroup separately
                if (field.hideExpression) {
                    field.fieldGroup.forEach(function (f) {
                        var /** @type {?} */ hideExpression = f.hideExpression || (function () { return false; });
                        if (typeof hideExpression === 'string') {
                            hideExpression = evalStringExpression(hideExpression, ['model', 'formState']);
                        }
                        f.hideExpression = function (model, formState) { return field.hide || hideExpression(model, formState); };
                    });
                }
                if (field.key) {
                    _this.addFormControl(form, field, (_a = {}, _a[field.key] = field.fieldArray ? [] : {}, _a), field.key);
                    _this._buildForm(/** @type {?} */ (field.formControl), field.fieldGroup, options);
                }
                else {
                    _this._buildForm(form, field.fieldGroup, options);
                }
            }
            var _a;
        });
    };
    /**
     * @param {?} field
     * @param {?} options
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldExpression = /**
     * @param {?} field
     * @param {?} options
     * @return {?}
     */
    function (field, options) {
        if (field.expressionProperties) {
            for (var /** @type {?} */ key in /** @type {?} */ (field.expressionProperties)) {
                if (typeof field.expressionProperties[key] === 'string' || isFunction(field.expressionProperties[key])) {
                    // cache built expression
                    field.expressionProperties[key] = {
                        expression: isFunction(field.expressionProperties[key]) ? field.expressionProperties[key] : evalStringExpression(field.expressionProperties[key], ['model', 'formState']),
                        expressionValueSetter: evalExpressionValueSetter("field." + key, ['expressionValue', 'model', 'field']),
                    };
                }
            }
        }
        if (field.hideExpression) {
            // delete hide value in order to force re-evaluate it in FormlyFormExpression.
            delete field.hide;
            if (typeof field.hideExpression === 'string') {
                // cache built expression
                field.hideExpression = evalStringExpression(field.hideExpression, ['model', 'formState']);
            }
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldOptions = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        field.templateOptions = field.templateOptions || {};
        if (field.type) {
            this.formlyConfig.getMergedField(field);
            if (field.key) {
                field.templateOptions = Object.assign({
                    label: '',
                    placeholder: '',
                    focus: false,
                }, field.templateOptions);
            }
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldAsyncValidation = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        var /** @type {?} */ validators = [];
        if (field.asyncValidators) {
            var _loop_1 = function (validatorName) {
                if (validatorName !== 'validation') {
                    var /** @type {?} */ validator_1 = field.asyncValidators[validatorName];
                    if (isObject(validator_1)) {
                        validator_1 = validator_1.expression;
                    }
                    validators.push(function (control) { return new Promise(function (resolve) {
                        return validator_1(control, field).then(function (result) {
                            resolve(result ? null : (_a = {}, _a[validatorName] = true, _a));
                            var _a;
                        });
                    }); });
                }
            };
            for (var /** @type {?} */ validatorName in field.asyncValidators) {
                _loop_1(validatorName);
            }
        }
        if (field.asyncValidators && Array.isArray(field.asyncValidators.validation)) {
            field.asyncValidators.validation
                .forEach(function (validator) { return validators.push(_this.wrapNgValidatorFn(field, validator)); });
        }
        if (validators.length) {
            if (field.asyncValidators && !Array.isArray(field.asyncValidators.validation)) {
                field.asyncValidators.validation = Validators.composeAsync(tslib_1.__spread([field.asyncValidators.validation], validators));
            }
            else {
                field.asyncValidators = {
                    validation: Validators.composeAsync(validators),
                };
            }
        }
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldValidation = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        var /** @type {?} */ validators = [];
        FORMLY_VALIDATORS
            .filter(function (opt) { return (field.templateOptions && field.templateOptions.hasOwnProperty(opt))
            || (field.expressionProperties && field.expressionProperties["templateOptions." + opt]); })
            .forEach(function (opt) {
            validators.push(function (control) {
                if (field.templateOptions[opt] === false) {
                    return null;
                }
                return _this.getValidation(opt, field.templateOptions[opt])(control);
            });
        });
        if (field.validators) {
            var _loop_2 = function (validatorName) {
                if (validatorName !== 'validation') {
                    var /** @type {?} */ validator_2 = field.validators[validatorName];
                    if (isObject(validator_2)) {
                        validator_2 = validator_2.expression;
                    }
                    validators.push(function (control) {
                        return validator_2(control, field) ? null : (_a = {}, _a[validatorName] = true, _a);
                        var _a;
                    });
                }
            };
            for (var /** @type {?} */ validatorName in field.validators) {
                _loop_2(validatorName);
            }
        }
        if (field.validators && Array.isArray(field.validators.validation)) {
            field.validators.validation
                .forEach(function (validator) { return validators.push(_this.wrapNgValidatorFn(field, validator)); });
        }
        if (validators.length) {
            if (field.validators && !Array.isArray(field.validators.validation)) {
                field.validators.validation = Validators.compose(tslib_1.__spread([field.validators.validation], validators));
            }
            else {
                field.validators = {
                    validation: Validators.compose(validators),
                };
            }
        }
    };
    /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    FormlyFormBuilder.prototype.addFormControl = /**
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    function (form, field, model, path) {
        var /** @type {?} */ control;
        var /** @type {?} */ validators = field.validators ? field.validators.validation : undefined, /** @type {?} */
        asyncValidators = field.asyncValidators ? field.asyncValidators.validation : undefined, /** @type {?} */
        updateOn = field.modelOptions && field.modelOptions.updateOn ?
            field.modelOptions.updateOn : undefined;
        var /** @type {?} */ abstractControlOptions = /** @type {?} */ ({
            validators: validators,
            asyncValidators: asyncValidators,
            updateOn: updateOn,
        });
        if (field.formControl instanceof AbstractControl || form.get(path)) {
            control = field.formControl || form.get(path);
            if (!(isNullOrUndefined(control.value) && isNullOrUndefined(model[path]))
                && control.value !== model[path]
                && control instanceof FormControl) {
                control.patchValue(model[path]);
            }
        }
        else if (field.component && field.component.createControl) {
            control = field.component.createControl(model[path], field);
        }
        else if (field.fieldGroup && field.key && field.key === path && !field.fieldArray) {
            control = new FormGroup(model[path], abstractControlOptions);
        }
        else if (field.fieldArray && field.key && field.key === path) {
            control = new FormArray([], abstractControlOptions);
        }
        else {
            control = new FormControl(model[path], abstractControlOptions);
        }
        if (field.templateOptions.disabled) {
            control.disable();
        }
        // Replace decorated property with a getter that returns the observable.
        // https://github.com/angular-redux/store/blob/master/src/decorators/select.ts#L79-L85
        if (delete field.templateOptions.disabled) {
            Object.defineProperty(field.templateOptions, 'disabled', {
                get: (function () { return !this.formControl.enabled; }).bind(field),
                set: (function (value) {
                    if (this.expressionProperties && this.expressionProperties.hasOwnProperty('templateOptions.disabled')) {
                        this.expressionProperties['templateOptions.disabled'].expressionValue = value;
                    }
                    value ? this.formControl.disable() : this.formControl.enable();
                }).bind(field),
                enumerable: true,
                configurable: true,
            });
        }
        this.addControl(form, path, control, field);
    };
    /**
     * @param {?} form
     * @param {?} key
     * @param {?} formControl
     * @param {?=} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.addControl = /**
     * @param {?} form
     * @param {?} key
     * @param {?} formControl
     * @param {?=} field
     * @return {?}
     */
    function (form, key, formControl, field) {
        if (field) {
            field.formControl = formControl;
        }
        if (form instanceof FormArray) {
            if (form.at(/** @type {?} */ (key)) !== formControl) {
                form.setControl(/** @type {?} */ (key), formControl);
            }
        }
        else {
            if (form.get(/** @type {?} */ (key)) !== formControl) {
                form.setControl(/** @type {?} */ (key), formControl);
            }
        }
    };
    /**
     * @param {?} opt
     * @param {?} value
     * @return {?}
     */
    FormlyFormBuilder.prototype.getValidation = /**
     * @param {?} opt
     * @param {?} value
     * @return {?}
     */
    function (opt, value) {
        switch (opt) {
            case 'required':
                return Validators.required;
            case 'pattern':
                return Validators.pattern(value);
            case 'minLength':
                return Validators.minLength(value);
            case 'maxLength':
                return Validators.maxLength(value);
            case 'min':
                return Validators.min(value);
            case 'max':
                return Validators.max(value);
        }
    };
    /**
     * @param {?} field
     * @param {?} validator
     * @return {?}
     */
    FormlyFormBuilder.prototype.wrapNgValidatorFn = /**
     * @param {?} field
     * @param {?} validator
     * @return {?}
     */
    function (field, validator) {
        validator = typeof validator === 'string'
            ? this.formlyConfig.getValidator(validator).validation
            : validator;
        return function (control) { return (/** @type {?} */ (validator))(control, field); };
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormlyFormBuilder.prototype.initFieldWrappers = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var /** @type {?} */ templateManipulators = {
            preWrapper: [],
            postWrapper: [],
        };
        if (field.templateOptions) {
            this.mergeTemplateManipulators(templateManipulators, field.templateOptions.templateManipulators);
        }
        this.mergeTemplateManipulators(templateManipulators, this.formlyConfig.templateManipulators);
        var /** @type {?} */ preWrappers = templateManipulators.preWrapper.map(function (m) { return m(field); }).filter(function (type) { return type; }), /** @type {?} */
        postWrappers = templateManipulators.postWrapper.map(function (m) { return m(field); }).filter(function (type) { return type; });
        if (!field.wrappers) {
            field.wrappers = [];
        }
        field.wrappers = tslib_1.__spread(preWrappers, (field.wrappers || []), postWrappers);
    };
    /**
     * @param {?} source
     * @param {?} target
     * @return {?}
     */
    FormlyFormBuilder.prototype.mergeTemplateManipulators = /**
     * @param {?} source
     * @param {?} target
     * @return {?}
     */
    function (source, target) {
        target = target || {};
        if (target.preWrapper) {
            source.preWrapper = source.preWrapper.concat(target.preWrapper);
        }
        if (target.postWrapper) {
            source.postWrapper = source.postWrapper.concat(target.postWrapper);
        }
        return source;
    };
    FormlyFormBuilder.decorators = [
        { type: Injectable },
    ];
    /** @nocollapse */
    FormlyFormBuilder.ctorParameters = function () { return [
        { type: FormlyConfig },
        { type: FormlyFormExpression }
    ]; };
    return FormlyFormBuilder;
}());
export { FormlyFormBuilder };
function FormlyFormBuilder_tsickle_Closure_declarations() {
    /** @type {?} */
    FormlyFormBuilder.prototype.formId;
    /** @type {?} */
    FormlyFormBuilder.prototype.formlyConfig;
    /** @type {?} */
    FormlyFormBuilder.prototype.formlyFormExpression;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWx5LmZvcm0uYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZm9ybWx5LmZvcm0uYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQTBCLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEgsT0FBTyxFQUFFLFlBQVksRUFBMEMsTUFBTSxpQkFBaUIsQ0FBQztBQUN2RixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsb0JBQW9CLEVBQUUseUJBQXlCLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFckssT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7O0lBTTlELDJCQUNVLGNBQ0E7UUFEQSxpQkFBWSxHQUFaLFlBQVk7UUFDWix5QkFBb0IsR0FBcEIsb0JBQW9CO3NCQUpiLENBQUM7S0FLZDs7Ozs7Ozs7SUFFSixxQ0FBUzs7Ozs7OztJQUFULFVBQVUsSUFBMkIsRUFBRSxNQUFnQyxFQUFFLEtBQVUsRUFBRSxPQUEwQjtRQUF4RSx1QkFBQSxFQUFBLFdBQWdDO1FBQ3JFLHFCQUFJLGVBQWUsR0FBRyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDO1FBQ3JHLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMs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QixNQUFNLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNwRTtRQUVELE1BQU0sQ0FBQyxNQUFNLENBQUM7OztnQkEvVmpCLFVBQVU7Ozs7Z0JBTkYsWUFBWTtnQkFJWixvQkFBb0I7OzRCQU43Qjs7U0FTYSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtR3JvdXAsIEZvcm1BcnJheSwgRm9ybUNvbnRyb2wsIEFic3RyYWN0Q29udHJvbCwgVmFsaWRhdG9ycywgQWJzdHJhY3RDb250cm9sT3B0aW9ucyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEZvcm1seUNvbmZpZywgRmllbGRWYWxpZGF0b3JGbiwgVGVtcGxhdGVNYW5pcHVsYXRvcnMgfSBmcm9tICcuL2Zvcm1seS5jb25maWcnO1xuaW1wb3J0IHsgRk9STUxZX1ZBTElEQVRPUlMsIGV2YWxTdHJpbmdFeHByZXNzaW9uLCBldmFsRXhwcmVzc2lvblZhbHVlU2V0dGVyLCBnZXRGaWVsZElkLCBpc09iamVjdCwgaXNOdWxsT3JVbmRlZmluZWQsIGNsb25lLCBhc3NpZ25Nb2RlbFRvRmllbGRzIH0gZnJvbSAnLi8uLi91dGlscyc7XG5pbXBvcnQgeyBGb3JtbHlGaWVsZENvbmZpZywgRm9ybWx5Rm9ybU9wdGlvbnMgfSBmcm9tICcuLi9jb21wb25lbnRzL2Zvcm1seS5maWVsZC5jb25maWcnO1xuaW1wb3J0IHsgZ2V0S2V5UGF0aCwgaXNGdW5jdGlvbiB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IEZvcm1seUZvcm1FeHByZXNzaW9uIH0gZnJvbSAnLi9mb3JtbHkuZm9ybS5leHByZXNzaW9uJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZvcm1seUZvcm1CdWlsZGVyIHtcbiAgcHJpdmF0ZSBmb3JtSWQgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZm9ybWx5Q29uZmlnOiBGb3JtbHlDb25maWcsXG4gICAgcHJpdmF0ZSBmb3JtbHlGb3JtRXhwcmVzc2lvbjogRm9ybWx5Rm9ybUV4cHJlc3Npb24sXG4gICkge31cblxuICBidWlsZEZvcm0oZm9ybTogRm9ybUdyb3VwIHwgRm9ybUFycmF5LCBmaWVsZHM6IEZvcm1seUZpZWxkQ29uZmlnW10gPSBbXSwgbW9kZWw6IGFueSwgb3B0aW9uczogRm9ybWx5Rm9ybU9wdGlvbnMpIHtcbiAgICBsZXQgZmllbGRUcmFuc2Zvcm1zID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5maWVsZFRyYW5zZm9ybSkgfHwgdGhpcy5mb3JtbHlDb25maWcuZXh0cmFzLmZpZWxkVHJhbnNmb3JtO1xuICAgIGlmICghQXJyYXkuaXNBcnJheShmaWVsZFRyYW5zZm9ybXMpKSB7XG4gICAgICBmaWVsZFRyYW5zZm9ybXMgPSBbZmllbGRUcmFuc2Zvcm1zXTtcbiAgICB9XG5cbiAgICBmaWVsZFRyYW5zZm9ybXMuZm9yRWFjaChmaWVsZFRyYW5zZm9ybSA9PiB7XG4gICAgICBpZiAoZmllbGRUcmFuc2Zvcm0pIHtcbiAgICAgICAgZmllbGRzID0gZmllbGRUcmFuc2Zvcm0oZmllbGRzLCBtb2RlbCwgZm9ybSwgb3B0aW9ucyk7XG4gICAgICAgIGlmICghZmllbGRzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdmaWVsZFRyYW5zZm9ybSBtdXN0IHJldHVybiBhbiBhcnJheSBvZiBmaWVsZHMnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXNzaWduTW9kZWxUb0ZpZWxkcyhmaWVsZHMsIG1vZGVsKTtcbiAgICB0aGlzLl9idWlsZEZvcm0oZm9ybSwgZmllbGRzLCBvcHRpb25zKTtcbiAgICB0aGlzLmZvcm1seUZvcm1FeHByZXNzaW9uLmNoZWNrRmllbGRzKGZvcm0sIGZpZWxkcywgbW9kZWwsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfYnVpbGRGb3JtKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdID0gW10sIG9wdGlvbnM6IEZvcm1seUZvcm1PcHRpb25zKSB7XG4gICAgdGhpcy5mb3JtSWQrKztcbiAgICB0aGlzLnJlZ2lzdGVyRm9ybUNvbnRyb2xzKGZvcm0sIGZpZWxkcywgb3B0aW9ucyk7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyRm9ybUNvbnRyb2xzKGZvcm06IEZvcm1Hcm91cCB8IEZvcm1BcnJheSwgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdLCBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucykge1xuICAgIGZpZWxkcy5mb3JFYWNoKChmaWVsZCwgaW5kZXgpID0+IHtcbiAgICAgIGZpZWxkLmlkID0gZ2V0RmllbGRJZChgZm9ybWx5XyR7dGhpcy5mb3JtSWR9YCwgZmllbGQsIGluZGV4KTtcbiAgICAgIHRoaXMuaW5pdEZpZWxkT3B0aW9ucyhmaWVsZCk7XG4gICAgICB0aGlzLmluaXRGaWVsZEV4cHJlc3Npb24oZmllbGQsIG9wdGlvbnMpO1xuICAgICAgdGhpcy5pbml0RmllbGRWYWxpZGF0aW9uKGZpZWxkKTtcbiAgICAgIHRoaXMuaW5pdEZpZWxkV3JhcHBlcnMoZmllbGQpO1xuICAgICAgdGhpcy5pbml0RmllbGRBc3luY1ZhbGlkYXRpb24oZmllbGQpO1xuXG4gICAgICBpZiAoZmllbGQua2V5ICYmIGZpZWxkLnR5cGUpIHtcbiAgICAgICAgY29uc3QgcGF0aHMgPSBnZXRLZXlQYXRoKHsga2V5OiBmaWVsZC5rZXkgfSk7XG4gICAgICAgIGxldCByb290Rm9ybSA9IGZvcm0sIHJvb3RNb2RlbCA9IGZpZWxkLm1vZGVsO1xuICAgICAgICBwYXRocy5mb3JFYWNoKChwYXRoLCBpbmRleCkgPT4ge1xuICAgICAgICAgIC8vIEZvcm1Hcm91cC9Gb3JtQXJyYXkgb25seSBhbGxvdyBzdHJpbmcgdmFsdWUgZm9yIHBhdGhcbiAgICAgICAgICBjb25zdCBmb3JtUGF0aCA9IHBhdGgudG9TdHJpbmcoKTtcbiAgICAgICAgICAvLyBpcyBsYXN0IGl0ZW1cbiAgICAgICAgICBpZiAoaW5kZXggPT09IHBhdGhzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRm9ybUNvbnRyb2wocm9vdEZvcm0sIGZpZWxkLCByb290TW9kZWwsIGZvcm1QYXRoKTtcbiAgICAgICAgICAgIGlmIChmaWVsZC5maWVsZEFycmF5KSB7XG4gICAgICAgICAgICAgIGZpZWxkLmZpZWxkR3JvdXAgPSBbXTtcbiAgICAgICAgICAgICAgZmllbGQubW9kZWwuZm9yRWFjaCgobTogYW55LCBpOiBudW1iZXIpID0+IGZpZWxkLmZpZWxkR3JvdXAucHVzaChcbiAgICAgICAgICAgICAgICB7IC4uLmNsb25lKGZpZWxkLmZpZWxkQXJyYXkpLCBrZXk6IGAke2l9YCB9LFxuICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgICAgYXNzaWduTW9kZWxUb0ZpZWxkcyhmaWVsZC5maWVsZEdyb3VwLCByb290TW9kZWwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBuZXN0ZWRGb3JtID0gcm9vdEZvcm0uZ2V0KGZvcm1QYXRoKSBhcyBGb3JtR3JvdXA7XG4gICAgICAgICAgICBpZiAoIW5lc3RlZEZvcm0pIHtcbiAgICAgICAgICAgICAgbmVzdGVkRm9ybSA9IG5ldyBGb3JtR3JvdXAoe30pO1xuICAgICAgICAgICAgICB0aGlzLmFkZENvbnRyb2wocm9vdEZvcm0sIGZvcm1QYXRoLCBuZXN0ZWRGb3JtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghcm9vdE1vZGVsW3BhdGhdKSB7XG4gICAgICAgICAgICAgIHJvb3RNb2RlbFtwYXRoXSA9IHR5cGVvZiBwYXRoID09PSAnc3RyaW5nJyA/IHt9IDogW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJvb3RGb3JtID0gbmVzdGVkRm9ybTtcbiAgICAgICAgICAgIHJvb3RNb2RlbCA9IHJvb3RNb2RlbFtwYXRoXTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmllbGQuZmllbGRHcm91cCkge1xuICAgICAgICBpZiAoIWZpZWxkLnR5cGUpIHtcbiAgICAgICAgICBmaWVsZC50eXBlID0gJ2Zvcm1seS1ncm91cCc7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpZiBgaGlkZUV4cHJlc3Npb25gIGlzIHNldCBpbiB0aGF0IGNhc2Ugd2UgaGF2ZSB0byBkZWFsXG4gICAgICAgIC8vIHdpdGggdG9nZ2xlIEZvcm1Db250cm9sIGZvciBlYWNoIGZpZWxkIGluIGZpZWxkR3JvdXAgc2VwYXJhdGVseVxuICAgICAgICBpZiAoZmllbGQuaGlkZUV4cHJlc3Npb24pIHtcbiAgICAgICAgICBmaWVsZC5maWVsZEdyb3VwLmZvckVhY2goZiA9PiB7XG4gICAgICAgICAgICBsZXQgaGlkZUV4cHJlc3Npb246IGFueSA9IGYuaGlkZUV4cHJlc3Npb24gfHwgKCgpID0+IGZhbHNlKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgaGlkZUV4cHJlc3Npb24gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgIGhpZGVFeHByZXNzaW9uID0gZXZhbFN0cmluZ0V4cHJlc3Npb24oaGlkZUV4cHJlc3Npb24sIFsnbW9kZWwnLCAnZm9ybVN0YXRlJ10pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmLmhpZGVFeHByZXNzaW9uID0gKG1vZGVsLCBmb3JtU3RhdGUpID0+IGZpZWxkLmhpZGUgfHwgaGlkZUV4cHJlc3Npb24obW9kZWwsIGZvcm1TdGF0ZSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZmllbGQua2V5KSB7XG4gICAgICAgICAgdGhpcy5hZGRGb3JtQ29udHJvbChmb3JtLCBmaWVsZCwgeyBbZmllbGQua2V5XTogZmllbGQuZmllbGRBcnJheSA/IFtdIDoge30gfSwgZmllbGQua2V5KTtcbiAgICAgICAgICB0aGlzLl9idWlsZEZvcm0oZmllbGQuZm9ybUNvbnRyb2wgYXMgRm9ybUdyb3VwLCBmaWVsZC5maWVsZEdyb3VwLCBvcHRpb25zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9idWlsZEZvcm0oZm9ybSwgZmllbGQuZmllbGRHcm91cCwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdEZpZWxkRXhwcmVzc2lvbihmaWVsZDogRm9ybWx5RmllbGRDb25maWcsIG9wdGlvbnM6IEZvcm1seUZvcm1PcHRpb25zKSB7XG4gICAgaWYgKGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzKSB7XG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcyBhcyBhbnkpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1trZXldID09PSAnc3RyaW5nJyB8fCBpc0Z1bmN0aW9uKGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0pKSB7XG4gICAgICAgICAgLy8gY2FjaGUgYnVpbHQgZXhwcmVzc2lvblxuICAgICAgICAgIGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0gPSB7XG4gICAgICAgICAgICBleHByZXNzaW9uOiBpc0Z1bmN0aW9uKGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0pID8gZmllbGQuZXhwcmVzc2lvblByb3BlcnRpZXNba2V5XSA6IGV2YWxTdHJpbmdFeHByZXNzaW9uKGZpZWxkLmV4cHJlc3Npb25Qcm9wZXJ0aWVzW2tleV0sIFsnbW9kZWwnLCAnZm9ybVN0YXRlJ10pLFxuICAgICAgICAgICAgZXhwcmVzc2lvblZhbHVlU2V0dGVyOiBldmFsRXhwcmVzc2lvblZhbHVlU2V0dGVyKFxuICAgICAgICAgICAgICBgZmllbGQuJHtrZXl9YCxcbiAgICAgICAgICAgICAgWydleHByZXNzaW9uVmFsdWUnLCAnbW9kZWwnLCAnZmllbGQnXSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChmaWVsZC5oaWRlRXhwcmVzc2lvbikge1xuICAgICAgLy8gZGVsZXRlIGhpZGUgdmFsdWUgaW4gb3JkZXIgdG8gZm9yY2UgcmUtZXZhbHVhdGUgaXQgaW4gRm9ybWx5Rm9ybUV4cHJlc3Npb24uXG4gICAgICBkZWxldGUgZmllbGQuaGlkZTtcbiAgICAgIGlmICh0eXBlb2YgZmllbGQuaGlkZUV4cHJlc3Npb24gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIC8vIGNhY2hlIGJ1aWx0IGV4cHJlc3Npb25cbiAgICAgICAgZmllbGQuaGlkZUV4cHJlc3Npb24gPSBldmFsU3RyaW5nRXhwcmVzc2lvbihmaWVsZC5oaWRlRXhwcmVzc2lvbiwgWydtb2RlbCcsICdmb3JtU3RhdGUnXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRPcHRpb25zKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZykge1xuICAgIGZpZWxkLnRlbXBsYXRlT3B0aW9ucyA9IGZpZWxkLnRlbXBsYXRlT3B0aW9ucyB8fCB7fTtcbiAgICBpZiAoZmllbGQudHlwZSkge1xuICAgICAgdGhpcy5mb3JtbHlDb25maWcuZ2V0TWVyZ2VkRmllbGQoZmllbGQpO1xuICAgICAgaWYgKGZpZWxkLmtleSkge1xuICAgICAgICBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgICBsYWJlbDogJycsXG4gICAgICAgICAgcGxhY2Vob2xkZXI6ICcnLFxuICAgICAgICAgIGZvY3VzOiBmYWxzZSxcbiAgICAgICAgfSwgZmllbGQudGVtcGxhdGVPcHRpb25zKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXRGaWVsZEFzeW5jVmFsaWRhdGlvbihmaWVsZDogRm9ybWx5RmllbGRDb25maWcpIHtcbiAgICBjb25zdCB2YWxpZGF0b3JzOiBhbnkgPSBbXTtcbiAgICBpZiAoZmllbGQuYXN5bmNWYWxpZGF0b3JzKSB7XG4gICAgICBmb3IgKGNvbnN0IHZhbGlkYXRvck5hbWUgaW4gZmllbGQuYXN5bmNWYWxpZGF0b3JzKSB7XG4gICAgICAgIGlmICh2YWxpZGF0b3JOYW1lICE9PSAndmFsaWRhdGlvbicpIHtcbiAgICAgICAgICBsZXQgdmFsaWRhdG9yID0gZmllbGQuYXN5bmNWYWxpZGF0b3JzW3ZhbGlkYXRvck5hbWVdO1xuICAgICAgICAgIGlmIChpc09iamVjdCh2YWxpZGF0b3IpKSB7XG4gICAgICAgICAgICB2YWxpZGF0b3IgPSB2YWxpZGF0b3IuZXhwcmVzc2lvbjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB2YWxpZGF0b3JzLnB1c2goKGNvbnRyb2w6IEZvcm1Db250cm9sKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRvcihjb250cm9sLCBmaWVsZCkudGhlbigocmVzdWx0OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0ID8gbnVsbCA6IHsgW3ZhbGlkYXRvck5hbWVdOiB0cnVlIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkLmFzeW5jVmFsaWRhdG9ycyAmJiBBcnJheS5pc0FycmF5KGZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uKSkge1xuICAgICAgZmllbGQuYXN5bmNWYWxpZGF0b3JzLnZhbGlkYXRpb25cbiAgICAgICAgLmZvckVhY2goKHZhbGlkYXRvcjogYW55KSA9PiB2YWxpZGF0b3JzLnB1c2godGhpcy53cmFwTmdWYWxpZGF0b3JGbihmaWVsZCwgdmFsaWRhdG9yKSkpO1xuICAgIH1cblxuICAgIGlmICh2YWxpZGF0b3JzLmxlbmd0aCkge1xuICAgICAgaWYgKGZpZWxkLmFzeW5jVmFsaWRhdG9ycyAmJiAhQXJyYXkuaXNBcnJheShmaWVsZC5hc3luY1ZhbGlkYXRvcnMudmFsaWRhdGlvbikpIHtcbiAgICAgICAgZmllbGQuYXN5bmNWYWxpZGF0b3JzLnZhbGlkYXRpb24gPSBWYWxpZGF0b3JzLmNvbXBvc2VBc3luYyhbZmllbGQuYXN5bmNWYWxpZGF0b3JzLnZhbGlkYXRpb24sIC4uLnZhbGlkYXRvcnNdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpZWxkLmFzeW5jVmFsaWRhdG9ycyA9IHtcbiAgICAgICAgICB2YWxpZGF0aW9uOiBWYWxpZGF0b3JzLmNvbXBvc2VBc3luYyh2YWxpZGF0b3JzKSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXRGaWVsZFZhbGlkYXRpb24oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnKSB7XG4gICAgY29uc3QgdmFsaWRhdG9yczogYW55ID0gW107XG4gICAgRk9STUxZX1ZBTElEQVRPUlNcbiAgICAgIC5maWx0ZXIob3B0ID0+IChmaWVsZC50ZW1wbGF0ZU9wdGlvbnMgJiYgZmllbGQudGVtcGxhdGVPcHRpb25zLmhhc093blByb3BlcnR5KG9wdCkpXG4gICAgICAgIHx8IChmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcyAmJiBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1tgdGVtcGxhdGVPcHRpb25zLiR7b3B0fWBdKSxcbiAgICAgIClcbiAgICAgIC5mb3JFYWNoKChvcHQpID0+IHtcbiAgICAgICAgdmFsaWRhdG9ycy5wdXNoKChjb250cm9sOiBGb3JtQ29udHJvbCkgPT4ge1xuICAgICAgICAgIGlmIChmaWVsZC50ZW1wbGF0ZU9wdGlvbnNbb3B0XSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbGlkYXRpb24ob3B0LCBmaWVsZC50ZW1wbGF0ZU9wdGlvbnNbb3B0XSkoY29udHJvbCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICBpZiAoZmllbGQudmFsaWRhdG9ycykge1xuICAgICAgZm9yIChjb25zdCB2YWxpZGF0b3JOYW1lIGluIGZpZWxkLnZhbGlkYXRvcnMpIHtcbiAgICAgICAgaWYgKHZhbGlkYXRvck5hbWUgIT09ICd2YWxpZGF0aW9uJykge1xuICAgICAgICAgIGxldCB2YWxpZGF0b3IgPSBmaWVsZC52YWxpZGF0b3JzW3ZhbGlkYXRvck5hbWVdO1xuICAgICAgICAgIGlmIChpc09iamVjdCh2YWxpZGF0b3IpKSB7XG4gICAgICAgICAgICB2YWxpZGF0b3IgPSB2YWxpZGF0b3IuZXhwcmVzc2lvbjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB2YWxpZGF0b3JzLnB1c2goKGNvbnRyb2w6IEZvcm1Db250cm9sKSA9PiB2YWxpZGF0b3IoY29udHJvbCwgZmllbGQpID8gbnVsbCA6IHsgW3ZhbGlkYXRvck5hbWVdOiB0cnVlIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkLnZhbGlkYXRvcnMgJiYgQXJyYXkuaXNBcnJheShmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24pKSB7XG4gICAgICBmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb25cbiAgICAgICAgLmZvckVhY2goKHZhbGlkYXRvcjogYW55KSA9PiB2YWxpZGF0b3JzLnB1c2godGhpcy53cmFwTmdWYWxpZGF0b3JGbihmaWVsZCwgdmFsaWRhdG9yKSkpO1xuICAgIH1cblxuICAgIGlmICh2YWxpZGF0b3JzLmxlbmd0aCkge1xuICAgICAgaWYgKGZpZWxkLnZhbGlkYXRvcnMgJiYgIUFycmF5LmlzQXJyYXkoZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uKSkge1xuICAgICAgICBmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24gPSBWYWxpZGF0b3JzLmNvbXBvc2UoW2ZpZWxkLnZhbGlkYXRvcnMudmFsaWRhdGlvbiwgLi4udmFsaWRhdG9yc10pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmllbGQudmFsaWRhdG9ycyA9IHtcbiAgICAgICAgICB2YWxpZGF0aW9uOiBWYWxpZGF0b3JzLmNvbXBvc2UodmFsaWRhdG9ycyksXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRGb3JtQ29udHJvbChmb3JtOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXksIGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZywgbW9kZWw6IGFueSwgcGF0aDogc3RyaW5nKSB7XG4gICAgbGV0IGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbDtcbiAgICBjb25zdCB2YWxpZGF0b3JzID0gZmllbGQudmFsaWRhdG9ycyA/IGZpZWxkLnZhbGlkYXRvcnMudmFsaWRhdGlvbiA6IHVuZGVmaW5lZCxcbiAgICAgIGFzeW5jVmFsaWRhdG9ycyA9IGZpZWxkLmFzeW5jVmFsaWRhdG9ycyA/IGZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uIDogdW5kZWZpbmVkLFxuICAgICAgdXBkYXRlT24gPSBmaWVsZC5tb2RlbE9wdGlvbnMgJiYgZmllbGQubW9kZWxPcHRpb25zLnVwZGF0ZU9uID9cbiAgICAgICAgZmllbGQubW9kZWxPcHRpb25zLnVwZGF0ZU9uIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IGFic3RyYWN0Q29udHJvbE9wdGlvbnMgPSB7XG4gICAgICB2YWxpZGF0b3JzLFxuICAgICAgYXN5bmNWYWxpZGF0b3JzLFxuICAgICAgdXBkYXRlT24sXG4gICAgfSBhcyBBYnN0cmFjdENvbnRyb2xPcHRpb25zO1xuXG4gICAgaWYgKGZpZWxkLmZvcm1Db250cm9sIGluc3RhbmNlb2YgQWJzdHJhY3RDb250cm9sIHx8IGZvcm0uZ2V0KHBhdGgpKSB7XG4gICAgICBjb250cm9sID0gZmllbGQuZm9ybUNvbnRyb2wgfHwgZm9ybS5nZXQocGF0aCk7XG4gICAgICBpZiAoXG4gICAgICAgICEoaXNOdWxsT3JVbmRlZmluZWQoY29udHJvbC52YWx1ZSkgJiYgaXNOdWxsT3JVbmRlZmluZWQobW9kZWxbcGF0aF0pKVxuICAgICAgICAmJiBjb250cm9sLnZhbHVlICE9PSBtb2RlbFtwYXRoXVxuICAgICAgICAmJiBjb250cm9sIGluc3RhbmNlb2YgRm9ybUNvbnRyb2xcbiAgICAgICkge1xuICAgICAgICBjb250cm9sLnBhdGNoVmFsdWUobW9kZWxbcGF0aF0pO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZmllbGQuY29tcG9uZW50ICYmIGZpZWxkLmNvbXBvbmVudC5jcmVhdGVDb250cm9sKSB7XG4gICAgICBjb250cm9sID0gZmllbGQuY29tcG9uZW50LmNyZWF0ZUNvbnRyb2wobW9kZWxbcGF0aF0sIGZpZWxkKTtcbiAgICB9IGVsc2UgaWYgKGZpZWxkLmZpZWxkR3JvdXAgJiYgZmllbGQua2V5ICYmIGZpZWxkLmtleSA9PT0gcGF0aCAmJiAhZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgY29udHJvbCA9IG5ldyBGb3JtR3JvdXAobW9kZWxbcGF0aF0sIGFic3RyYWN0Q29udHJvbE9wdGlvbnMpO1xuICAgIH0gZWxzZSBpZiAoZmllbGQuZmllbGRBcnJheSAmJiBmaWVsZC5rZXkgJiYgZmllbGQua2V5ID09PSBwYXRoKSB7XG4gICAgICBjb250cm9sID0gbmV3IEZvcm1BcnJheShbXSwgYWJzdHJhY3RDb250cm9sT3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2wobW9kZWxbcGF0aF0sIGFic3RyYWN0Q29udHJvbE9wdGlvbnMpO1xuICAgIH1cblxuICAgIGlmIChmaWVsZC50ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQpIHtcbiAgICAgIGNvbnRyb2wuZGlzYWJsZSgpO1xuICAgIH1cblxuICAgIC8vIFJlcGxhY2UgZGVjb3JhdGVkIHByb3BlcnR5IHdpdGggYSBnZXR0ZXIgdGhhdCByZXR1cm5zIHRoZSBvYnNlcnZhYmxlLlxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLXJlZHV4L3N0b3JlL2Jsb2IvbWFzdGVyL3NyYy9kZWNvcmF0b3JzL3NlbGVjdC50cyNMNzktTDg1XG4gICAgaWYgKGRlbGV0ZSBmaWVsZC50ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQpIHtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmaWVsZC50ZW1wbGF0ZU9wdGlvbnMsICdkaXNhYmxlZCcsIHtcbiAgICAgICAgZ2V0OiAoZnVuY3Rpb24gKCkgeyByZXR1cm4gIXRoaXMuZm9ybUNvbnRyb2wuZW5hYmxlZDsgfSkuYmluZChmaWVsZCksXG4gICAgICAgIHNldDogKGZ1bmN0aW9uICh2YWx1ZTogYm9vbGVhbikge1xuICAgICAgICAgIGlmICh0aGlzLmV4cHJlc3Npb25Qcm9wZXJ0aWVzICYmIHRoaXMuZXhwcmVzc2lvblByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoJ3RlbXBsYXRlT3B0aW9ucy5kaXNhYmxlZCcpKSB7XG4gICAgICAgICAgICB0aGlzLmV4cHJlc3Npb25Qcm9wZXJ0aWVzWyd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnXS5leHByZXNzaW9uVmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB2YWx1ZSA/IHRoaXMuZm9ybUNvbnRyb2wuZGlzYWJsZSgpIDogdGhpcy5mb3JtQ29udHJvbC5lbmFibGUoKTtcbiAgICAgICAgfSkuYmluZChmaWVsZCksXG4gICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMuYWRkQ29udHJvbChmb3JtLCBwYXRoLCBjb250cm9sLCBmaWVsZCk7XG4gIH1cblxuICBwcml2YXRlIGFkZENvbnRyb2woZm9ybTogRm9ybUdyb3VwIHwgRm9ybUFycmF5LCBrZXk6IHN0cmluZyB8IG51bWJlciwgZm9ybUNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCwgZmllbGQ/OiBGb3JtbHlGaWVsZENvbmZpZykge1xuICAgIGlmIChmaWVsZCkge1xuICAgICAgZmllbGQuZm9ybUNvbnRyb2wgPSBmb3JtQ29udHJvbDtcbiAgICB9XG5cbiAgICBpZiAoZm9ybSBpbnN0YW5jZW9mIEZvcm1BcnJheSkge1xuICAgICAgaWYgKGZvcm0uYXQoPG51bWJlcj4ga2V5KSAhPT0gZm9ybUNvbnRyb2wpIHtcbiAgICAgICAgZm9ybS5zZXRDb250cm9sKDxudW1iZXI+a2V5LCBmb3JtQ29udHJvbCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChmb3JtLmdldCg8c3RyaW5nPiBrZXkpICE9PSBmb3JtQ29udHJvbCkge1xuICAgICAgICBmb3JtLnNldENvbnRyb2woPHN0cmluZz5rZXksIGZvcm1Db250cm9sKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFZhbGlkYXRpb24ob3B0OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICBzd2l0Y2ggKG9wdCkge1xuICAgICAgY2FzZSAncmVxdWlyZWQnOlxuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5yZXF1aXJlZDtcbiAgICAgIGNhc2UgJ3BhdHRlcm4nOlxuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5wYXR0ZXJuKHZhbHVlKTtcbiAgICAgIGNhc2UgJ21pbkxlbmd0aCc6XG4gICAgICAgIHJldHVybiBWYWxpZGF0b3JzLm1pbkxlbmd0aCh2YWx1ZSk7XG4gICAgICBjYXNlICdtYXhMZW5ndGgnOlxuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5tYXhMZW5ndGgodmFsdWUpO1xuICAgICAgY2FzZSAnbWluJzpcbiAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMubWluKHZhbHVlKTtcbiAgICAgIGNhc2UgJ21heCc6XG4gICAgICAgIHJldHVybiBWYWxpZGF0b3JzLm1heCh2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB3cmFwTmdWYWxpZGF0b3JGbihmaWVsZDogRm9ybWx5RmllbGRDb25maWcsIHZhbGlkYXRvcjogc3RyaW5nIHwgRmllbGRWYWxpZGF0b3JGbikge1xuICAgIHZhbGlkYXRvciA9IHR5cGVvZiB2YWxpZGF0b3IgPT09ICdzdHJpbmcnXG4gICAgPyB0aGlzLmZvcm1seUNvbmZpZy5nZXRWYWxpZGF0b3IodmFsaWRhdG9yKS52YWxpZGF0aW9uXG4gICAgOiB2YWxpZGF0b3I7XG5cbiAgICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCkgPT4gKHZhbGlkYXRvciBhcyBGaWVsZFZhbGlkYXRvckZuKShjb250cm9sLCBmaWVsZCk7XG4gIH1cblxuICBwcml2YXRlIGluaXRGaWVsZFdyYXBwZXJzKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZykge1xuICAgIGNvbnN0IHRlbXBsYXRlTWFuaXB1bGF0b3JzOiBUZW1wbGF0ZU1hbmlwdWxhdG9ycyA9IHtcbiAgICAgIHByZVdyYXBwZXI6IFtdLFxuICAgICAgcG9zdFdyYXBwZXI6IFtdLFxuICAgIH07XG5cbiAgICBpZiAoZmllbGQudGVtcGxhdGVPcHRpb25zKSB7XG4gICAgICB0aGlzLm1lcmdlVGVtcGxhdGVNYW5pcHVsYXRvcnModGVtcGxhdGVNYW5pcHVsYXRvcnMsIGZpZWxkLnRlbXBsYXRlT3B0aW9ucy50ZW1wbGF0ZU1hbmlwdWxhdG9ycyk7XG4gICAgfVxuXG4gICAgdGhpcy5tZXJnZVRlbXBsYXRlTWFuaXB1bGF0b3JzKHRlbXBsYXRlTWFuaXB1bGF0b3JzLCB0aGlzLmZvcm1seUNvbmZpZy50ZW1wbGF0ZU1hbmlwdWxhdG9ycyk7XG5cbiAgICBjb25zdCBwcmVXcmFwcGVycyA9IHRlbXBsYXRlTWFuaXB1bGF0b3JzLnByZVdyYXBwZXIubWFwKG0gPT4gbShmaWVsZCkpLmZpbHRlcih0eXBlID0+IHR5cGUpLFxuICAgICAgcG9zdFdyYXBwZXJzID0gdGVtcGxhdGVNYW5pcHVsYXRvcnMucG9zdFdyYXBwZXIubWFwKG0gPT4gbShmaWVsZCkpLmZpbHRlcih0eXBlID0+IHR5cGUpO1xuXG4gICAgaWYgKCFmaWVsZC53cmFwcGVycykge1xuICAgICAgZmllbGQud3JhcHBlcnMgPSBbXTtcbiAgICB9XG5cbiAgICBmaWVsZC53cmFwcGVycyA9IFsuLi5wcmVXcmFwcGVycywgLi4uKGZpZWxkLndyYXBwZXJzIHx8IFtdKSwgLi4ucG9zdFdyYXBwZXJzXTtcbiAgfVxuXG4gIHByaXZhdGUgbWVyZ2VUZW1wbGF0ZU1hbmlwdWxhdG9ycyhzb3VyY2U6IFRlbXBsYXRlTWFuaXB1bGF0b3JzLCB0YXJnZXQ6IFRlbXBsYXRlTWFuaXB1bGF0b3JzKSB7XG4gICAgdGFyZ2V0ID0gdGFyZ2V0IHx8IHt9O1xuICAgIGlmICh0YXJnZXQucHJlV3JhcHBlcikge1xuICAgICAgc291cmNlLnByZVdyYXBwZXIgPSBzb3VyY2UucHJlV3JhcHBlci5jb25jYXQodGFyZ2V0LnByZVdyYXBwZXIpO1xuICAgIH1cbiAgICBpZiAodGFyZ2V0LnBvc3RXcmFwcGVyKSB7XG4gICAgICBzb3VyY2UucG9zdFdyYXBwZXIgPSBzb3VyY2UucG9zdFdyYXBwZXIuY29uY2F0KHRhcmdldC5wb3N0V3JhcHBlcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNvdXJjZTtcbiAgfVxufVxuIl19